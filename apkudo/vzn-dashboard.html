<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Apkudo Lifecycle Intelligence — Carrier Partner Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-card: #1e293b;
    --bg-card-hover: #263348;
    --border: #334155;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --accent: #3b82f6;
    --accent-light: #60a5fa;
    --green: #22c55e;
    --red: #ef4444;
    --amber: #f59e0b;
    --purple: #a78bfa;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
    background: var(--bg-primary); color: var(--text-primary);
    min-height: 100vh; overflow-x: hidden;
  }
  .header {
    background: linear-gradient(135deg, #0f172a 0%, #1a2744 100%);
    border-bottom: 1px solid var(--border); padding: 20px 40px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .header-left { display: flex; align-items: center; gap: 16px; }
  .logo {
    width: 42px; height: 42px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--purple));
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 18px; color: white;
  }
  .header-title { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
  .header-subtitle { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
  .header-right { display: flex; align-items: center; gap: 20px; }
  .header-badge {
    background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.3);
    color: var(--accent-light); padding: 6px 14px; border-radius: 20px;
    font-size: 12px; font-weight: 600;
  }
  .header-customer { font-size: 14px; color: var(--text-secondary); }
  .header-customer strong { color: var(--text-primary); }
  .filter-bar {
    background: var(--bg-secondary); border-bottom: 1px solid var(--border);
    padding: 12px 40px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
  }
  .filter-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
  .filter-select {
    background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border);
    padding: 7px 12px; border-radius: 8px; font-size: 13px; cursor: pointer; outline: none;
    transition: border-color 0.2s;
  }
  .filter-select:hover { border-color: var(--accent); }
  .filter-divider { width: 1px; height: 24px; background: var(--border); }
  .tabs {
    display: flex; background: var(--bg-secondary);
    border-bottom: 1px solid var(--border); padding: 0 40px;
  }
  .tab {
    padding: 14px 24px; font-size: 14px; font-weight: 600; cursor: pointer;
    color: var(--text-muted); border-bottom: 2px solid transparent;
    transition: all 0.2s; user-select: none;
  }
  .tab:hover { color: var(--text-secondary); }
  .tab.active { color: var(--accent-light); border-bottom-color: var(--accent); }
  .main { padding: 28px 40px; transition: opacity 0.2s; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .kpi-card {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
    padding: 20px 24px; transition: background 0.2s;
  }
  .kpi-card:hover { background: var(--bg-card-hover); }
  .kpi-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 8px; }
  .kpi-value { font-size: 32px; font-weight: 800; letter-spacing: -1px; }
  .kpi-delta { font-size: 12px; margin-top: 4px; font-weight: 600; }
  .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
  .chart-grid.full { grid-template-columns: 1fr; }
  .chart-card {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px;
  }
  .chart-card-title { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
  .chart-card-subtitle { font-size: 12px; color: var(--text-muted); margin-bottom: 16px; }
  .chart-container { position: relative; width: 100%; }
  .chart-container canvas { width: 100% !important; }
  .data-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  .data-table th {
    text-align: left; padding: 10px 16px; font-size: 11px; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700;
    border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2);
  }
  .data-table td { padding: 12px 16px; font-size: 13px; border-bottom: 1px solid rgba(51,65,85,0.5); }
  .data-table tr:hover td { background: rgba(59,130,246,0.05); }
  .badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; }
  .badge.green { background: rgba(34,197,94,0.15); color: var(--green); }
  .badge.red { background: rgba(239,68,68,0.15); color: var(--red); }
  .badge.amber { background: rgba(245,158,11,0.15); color: var(--amber); }
  .badge.blue { background: rgba(59,130,246,0.15); color: var(--accent-light); }
  .heatmap-grid { display: grid; grid-template-columns: 120px repeat(6,1fr); gap: 2px; margin-top: 12px; }
  .heatmap-header { font-size: 11px; color: var(--text-muted); font-weight: 600; padding: 8px; text-align: center; }
  .heatmap-row-label { font-size: 12px; color: var(--text-secondary); padding: 10px 8px; display: flex; align-items: center; }
  .heatmap-cell {
    padding: 10px; text-align: center; border-radius: 6px; font-size: 13px; font-weight: 700;
    transition: transform 0.15s; cursor: default;
  }
  .heatmap-cell:hover { transform: scale(1.05); }
  .heatmap-cell.low { background: rgba(34,197,94,0.2); color: var(--green); }
  .heatmap-cell.med { background: rgba(245,158,11,0.2); color: var(--amber); }
  .heatmap-cell.high { background: rgba(239,68,68,0.2); color: var(--red); }
  .heatmap-cell.crit { background: rgba(239,68,68,0.4); color: #fca5a5; }
  .vendor-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 16px; }
  .vendor-card {
    background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px; padding: 20px;
    transition: border-color 0.2s;
  }
  .vendor-card:hover { border-color: var(--accent); }
  .vendor-name { font-size: 16px; font-weight: 700; margin-bottom: 12px; }
  .vendor-stat { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(51,65,85,0.3); }
  .vendor-stat:last-child { border-bottom: none; }
  .vendor-stat-label { font-size: 12px; color: var(--text-muted); }
  .vendor-stat-value { font-size: 14px; font-weight: 700; }
  .section-title { font-size: 13px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; margin-top: 8px; }
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: var(--bg-primary); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  .footer {
    text-align: center; padding: 24px 40px; color: var(--text-muted); font-size: 12px;
    border-top: 1px solid var(--border); margin-top: 20px;
  }
  .filter-active-indicator {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    background: var(--green); margin-right: 6px; animation: pulse 1.5s infinite;
  }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  @media (max-width: 1024px) {
    .kpi-row { grid-template-columns: repeat(2, 1fr); }
    .chart-grid, .chart-grid.full { grid-template-columns: 1fr; }
    .vendor-cards { grid-template-columns: 1fr; }
    .header, .filter-bar, .tabs, .main { padding-left: 20px; padding-right: 20px; }
  }
</style>
</head>
<body>

<div class="header">

    <div>
      <div class="header-title">Lifecycle Intelligence</div>
      <div class="header-subtitle">Powered by Apkudo Device Passport</div>
    </div>
  </div>
  <div class="header-right">
    <div class="header-badge">AI-Powered Insights</div>
    <div class="header-customer">Customer: <strong>Verizon Wireless</strong></div>
  </div>
</div>

<div class="filter-bar">
  <span class="filter-label">Filters:</span>
  <select class="filter-select" id="filterTimePeriod">
    <option value="fy-2025" selected>FY 2025</option>
    <option value="q4-2025">Q4 2025</option>
    <option value="q3-2025">Q3 2025</option>
    <option value="q2-2025">Q2 2025</option>
    <option value="q1-2025">Q1 2025</option>
  </select>
  <select class="filter-select" id="filterRegion">
    <option value="all" selected>All Regions</option>
    <option value="northeast">Northeast</option>
    <option value="southeast">Southeast</option>
    <option value="midwest">Midwest</option>
    <option value="west">West Coast</option>
  </select>
  <select class="filter-select" id="filterOem">
    <option value="all" selected>All OEMs</option>
    <option value="apple">Apple</option>
    <option value="samsung">Samsung</option>
    <option value="google">Google</option>
    <option value="motorola">Motorola</option>
  </select>
  <div class="filter-divider"></div>
  <span id="deviceCount" style="font-size:12px; color: var(--text-muted);"><span class="filter-active-indicator"></span>Total Devices in View: <strong style="color: var(--text-primary);">847,312</strong></span>
</div>

<div class="tabs">
  <div class="tab active" data-tab="residual">Residual Value</div>
  <div class="tab" data-tab="lifecycle">Lifecycle Cost</div>
  <div class="tab" data-tab="vendor">Vendor Performance</div>
  <div class="tab" data-tab="batch">Batch Risk</div>
</div>

<div class="main" id="mainContent">
  <!-- TAB 1 -->
  <div class="tab-content active" id="tab-residual">
    <div class="kpi-row" id="kpi-residual"></div>
    <div class="chart-grid">
      <div class="chart-card">
        <div class="chart-card-title">Value Recovery by Device Model</div>
        <div class="chart-card-subtitle" id="sub-recovery-model">Avg. resale price as % of original trade-in value</div>
        <div class="chart-container"><canvas id="chart-recovery-model"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-card-title">Recovery Rate Over Time</div>
        <div class="chart-card-subtitle">Monthly avg. recovery rate across filtered models</div>
        <div class="chart-container"><canvas id="chart-recovery-time"></canvas></div>
      </div>
    </div>
    <div class="chart-grid">
      <div class="chart-card">
        <div class="chart-card-title">Channel Performance Comparison</div>
        <div class="chart-card-subtitle">Avg. recovery rate by sales channel and condition grade</div>
        <div class="chart-container"><canvas id="chart-channel"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-card-title">Depreciation Curve by Grade</div>
        <div class="chart-card-subtitle">Value retention from intake over weeks in inventory</div>
        <div class="chart-container"><canvas id="chart-depreciation"></canvas></div>
      </div>
    </div>
  </div>

  <!-- TAB 2 -->
  <div class="tab-content" id="tab-lifecycle">
    <div class="kpi-row" id="kpi-lifecycle"></div>
    <div class="chart-grid">
      <div class="chart-card">
        <div class="chart-card-title">Total Cost of Ownership Waterfall</div>
        <div class="chart-card-subtitle">Cost breakdown per device across lifecycle stages</div>
        <div class="chart-container"><canvas id="chart-tco-waterfall"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-card-title">TCO by Device Model</div>
        <div class="chart-card-subtitle">Stacked cost components per model</div>
        <div class="chart-container"><canvas id="chart-tco-model"></canvas></div>
      </div>
    </div>
    <div class="chart-grid full">
      <div class="chart-card">
        <div class="chart-card-title">Quarterly Cost Trend</div>
        <div class="chart-card-subtitle">Avg. cost per device by category over quarters</div>
        <div class="chart-container" style="max-height:320px;"><canvas id="chart-cost-trend"></canvas></div>
      </div>
    </div>
    <div class="section-title">Model Cost Breakdown</div>
    <div class="chart-card"><div id="lifecycle-table-container"></div></div>
  </div>

  <!-- TAB 3 -->
  <div class="tab-content" id="tab-vendor">
    <div class="kpi-row" id="kpi-vendor"></div>
    <div id="vendor-cards-container"></div>
    <div class="chart-grid" style="margin-top:24px;">
      <div class="chart-card">
        <div class="chart-card-title">Vendor Comparison — Radar</div>
        <div class="chart-card-subtitle">Normalized scores across 5 performance dimensions</div>
        <div class="chart-container"><canvas id="chart-vendor-radar"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-card-title">Dispute Rate Trend by Vendor</div>
        <div class="chart-card-subtitle">Monthly dispute rate over selected period</div>
        <div class="chart-container"><canvas id="chart-vendor-dispute"></canvas></div>
      </div>
    </div>
    <div class="section-title" style="margin-top:24px;">All Vendor Rankings</div>
    <div class="chart-card"><div id="vendor-table-container"></div></div>
  </div>

  <!-- TAB 4 -->
  <div class="tab-content" id="tab-batch">
    <div class="kpi-row" id="kpi-batch"></div>
    <div class="section-title">Failure Rate Heatmap — SKU × Batch Quarter</div>
    <div class="chart-card"><div id="heatmap-container"></div></div>
    <div class="chart-grid" style="margin-top:24px;">
      <div class="chart-card">
        <div class="chart-card-title">Failure Rate Distribution by Batch</div>
        <div class="chart-card-subtitle">All batches — flagged batches highlighted in red</div>
        <div class="chart-container"><canvas id="chart-batch-dist"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-card-title">Return Rate Anomaly Timeline</div>
        <div class="chart-card-subtitle">Weekly return rates with anomaly detection threshold</div>
        <div class="chart-container"><canvas id="chart-batch-anomaly"></canvas></div>
      </div>
    </div>
    <div class="section-title" style="margin-top:24px;">Flagged Batch Details</div>
    <div class="chart-card"><div id="batch-table-container"></div></div>
  </div>
</div>

<div class="footer">
  Apkudo Lifecycle Intelligence Platform · AI-Powered Device Passport Analytics · Data simulated for demonstration purposes
</div>

<script>
// ══════════════════════════════════════════════════════════
// SEEDED PSEUDO-RANDOM DATA ENGINE
// ══════════════════════════════════════════════════════════

// Simple seeded PRNG (mulberry32)
function mulberry32(a) {
  return function() {
    a |= 0; a = a + 0x6D2B79F5 | 0;
    let t = Math.imul(a ^ a >>> 15, 1 | a);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}

// Hash a string to a seed number
function hashStr(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) { h = ((h << 5) - h + s.charCodeAt(i)) | 0; }
  return Math.abs(h);
}

// ══════════════════════════════════════════════════════════
// FILTER MODIFIER PROFILES
// Each filter value has multipliers/offsets that shift the base data
// ══════════════════════════════════════════════════════════

const TIME_MODS = {
  'fy-2025': { recovery: 0, tco: 0, risk: 0, devices: 847312, label: 'FY 2025', months: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'] },
  'q4-2025': { recovery: 1.5, tco: -3, risk: 2, devices: 218400, label: 'Q4 2025', months: ['Oct','Nov','Dec'] },
  'q3-2025': { recovery: 0.8, tco: -1, risk: -1, devices: 224100, label: 'Q3 2025', months: ['Jul','Aug','Sep'] },
  'q2-2025': { recovery: -0.6, tco: 2, risk: 1, devices: 209500, label: 'Q2 2025', months: ['Apr','May','Jun'] },
  'q1-2025': { recovery: -1.8, tco: 5, risk: 3, devices: 195312, label: 'Q1 2025', months: ['Jan','Feb','Mar'] },
};

const REGION_MODS = {
  'all':       { recovery: 0, tco: 0, risk: 0, deviceMult: 1.0, label: 'All Regions' },
  'northeast': { recovery: 2.1, tco: -4, risk: -1.5, deviceMult: 0.28, label: 'Northeast' },
  'southeast': { recovery: -1.2, tco: 3, risk: 2, deviceMult: 0.26, label: 'Southeast' },
  'midwest':   { recovery: -0.5, tco: 1, risk: 0.5, deviceMult: 0.22, label: 'Midwest' },
  'west':      { recovery: 1.8, tco: -2, risk: -0.8, deviceMult: 0.24, label: 'West Coast' },
};

const OEM_MODS = {
  'all':      { recovery: 0, tco: 0, risk: 0, deviceMult: 1.0, label: 'All OEMs',
                models: ['iPhone 15 Pro Max','iPhone 15 Pro','iPhone 14','Pixel 8 Pro','Galaxy S24+','Galaxy S24 Ultra','Moto G Power'] },
  'apple':    { recovery: 4.5, tco: -8, risk: -2, deviceMult: 0.42, label: 'Apple',
                models: ['iPhone 15 Pro Max','iPhone 15 Pro','iPhone 14','iPhone 13','iPhone SE (3rd)'] },
  'samsung':  { recovery: -2.8, tco: 6, risk: 3, deviceMult: 0.31, label: 'Samsung',
                models: ['Galaxy S24 Ultra','Galaxy S24+','Galaxy S24','Galaxy A54','Galaxy Z Flip 5'] },
  'google':   { recovery: 0.2, tco: -1, risk: -0.5, deviceMult: 0.12, label: 'Google',
                models: ['Pixel 8 Pro','Pixel 8','Pixel 7a','Pixel 7','Pixel 6a'] },
  'motorola': { recovery: -4.5, tco: 10, risk: 4, deviceMult: 0.15, label: 'Motorola',
                models: ['Moto G Power (2024)','Moto G Stylus','Moto Edge 40','Moto G 5G','Moto E (2024)'] },
};

// ══════════════════════════════════════════════════════════
// DATA GENERATOR — produces all dashboard data from filter state
// ══════════════════════════════════════════════════════════

function generateData(timePeriod, region, oem) {
  const tm = TIME_MODS[timePeriod], rm = REGION_MODS[region], om = OEM_MODS[oem];
  const seedStr = timePeriod + '|' + region + '|' + oem;
  const rng = mulberry32(hashStr(seedStr));
  const r = () => rng(); // shorthand
  const jitter = (base, range) => base + (r() - 0.5) * range;
  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

  // Device count
  const totalDevices = Math.round(tm.devices * rm.deviceMult * om.deviceMult);

  // Base recovery modified by filters
  const baseRecovery = 68.4 + tm.recovery + rm.recovery + om.recovery;

  // Models for this OEM filter
  const models = om.models;
  const modelCount = models.length;

  // ── RESIDUAL VALUE DATA ──
  const modelRecoveryBase = [78, 74, 72, 66, 62, 58, 52];
  const modelRecovery = models.map((_, i) => {
    const base = modelRecoveryBase[i % modelRecoveryBase.length] + tm.recovery + rm.recovery + (oem !== 'all' ? (r()-0.5)*6 : 0);
    return clamp(Math.round(base + (r()-0.5)*4), 35, 92);
  });
  // Sort descending for display
  const modelRecoverySorted = models.map((m, i) => ({ model: m, val: modelRecovery[i] }))
    .sort((a,b) => b.val - a.val);

  const monthLabels = tm.months;
  const recoveryTimeline = monthLabels.map((_, i) => {
    return clamp(+(baseRecovery + (r()-0.5)*3 + Math.sin(i*0.8)*1.5).toFixed(1), 52, 82);
  });

  const channelData = {
    b2b: [82,71,58,38].map(v => clamp(Math.round(v + tm.recovery + rm.recovery*0.8 + (r()-0.5)*4), 20, 95)),
    wholesale: [74,64,51,32].map(v => clamp(Math.round(v + tm.recovery*0.8 + rm.recovery*0.6 + (r()-0.5)*4), 15, 88)),
    auction: [68,56,42,24].map(v => clamp(Math.round(v + tm.recovery*0.6 + rm.recovery*0.4 + (r()-0.5)*4), 10, 82)),
    recycle: [12,10,8,6].map(v => clamp(Math.round(v + (r()-0.5)*3), 3, 20)),
  };

  const depreciationMod = (tm.recovery + rm.recovery + om.recovery) * 0.15;
  const depreciation = {
    A: [100,98,96,93,90,84,78,68].map(v => clamp(Math.round(v + depreciationMod + (r()-0.5)*2), 30, 100)),
    B: [100,97,93,88,83,75,68,56].map(v => clamp(Math.round(v + depreciationMod*0.8 + (r()-0.5)*2), 20, 100)),
    C: [100,95,88,80,73,62,53,40].map(v => clamp(Math.round(v + depreciationMod*0.5 + (r()-0.5)*2), 15, 100)),
    D: [100,92,82,72,62,48,38,25].map(v => clamp(Math.round(v + depreciationMod*0.3 + (r()-0.5)*2), 8, 100)),
  };

  const avgRecovery = clamp(+baseRecovery.toFixed(1), 48, 84);
  const revenueUplift = clamp(+(4.2 * rm.deviceMult * om.deviceMult + (tm.recovery*0.1) + (r()-0.5)*0.8).toFixed(1), 0.3, 8.5);
  const bestChannel = channelData.b2b[0] > channelData.wholesale[0] ? 'Direct B2B' : 'Wholesale';
  const channelPremium = Math.abs(channelData.b2b[0] - channelData.auction[0]);
  const sellWindow = rm.recovery > 0 ? '10–17 days' : tm.recovery < -1 ? '18–28 days' : '14–21 days';

  // ── LIFECYCLE COST DATA ──
  const baseTCO = 127 + tm.tco + rm.tco + om.tco;
  const avgTCO = clamp(Math.round(baseTCO + (r()-0.5)*6), 58, 210);
  const repairRatio = clamp(Math.round(34 + om.tco*0.4 + (r()-0.5)*6), 18, 52);
  const costSavings = clamp(+(2.8 * rm.deviceMult * om.deviceMult + (r()-0.5)*0.5).toFixed(1), 0.2, 6.4);

  const modelCostData = models.map((name, i) => {
    const intake = clamp(Math.round(15 + (r()-0.5)*6 + om.tco*0.1), 8, 28);
    const repair = clamp(Math.round(32 + (r()-0.5)*20 + om.tco*0.5), 12, 72);
    const processing = clamp(Math.round(13 + (r()-0.5)*4), 7, 22);
    const warranty = -clamp(Math.round(9 + (r()-0.5)*6), 2, 18);
    const tco = intake + repair + processing + warranty;
    const margin = clamp(Math.round(25 - repair*0.3 + (r()-0.5)*8), -5, 38);
    return { name, intake, repair, processing, warranty, tco, margin };
  });
  modelCostData.sort((a,b) => a.tco - b.tco);
  const highestCostModel = modelCostData[modelCostData.length - 1];

  const waterfallBase = {
    tradeIn: clamp(Math.round(42 + tm.tco*0.4 + (r()-0.5)*4), 28, 56),
    intake: clamp(Math.round(6 + (r()-0.5)*2), 3, 10),
    diag: clamp(Math.round(8 + (r()-0.5)*2), 4, 14),
    repair: clamp(Math.round(42 + om.tco*0.6 + (r()-0.5)*8), 18, 65),
    process: clamp(Math.round(14 + (r()-0.5)*3), 8, 22),
    inventory: clamp(Math.round(15 + rm.tco*0.3 + (r()-0.5)*4), 6, 26),
    warranty: -clamp(Math.round(12 + (r()-0.5)*4), 4, 22),
  };
  waterfallBase.total = waterfallBase.tradeIn + waterfallBase.intake + waterfallBase.diag + waterfallBase.repair +
                         waterfallBase.process + waterfallBase.inventory + waterfallBase.warranty;

  const quarterLabels = ['Q1 2024','Q2 2024','Q3 2024','Q4 2024','Q1 2025','Q2 2025','Q3 2025','Q4 2025'];
  const costTrend = {
    repair: quarterLabels.map((_,i) => clamp(Math.round(38 + i*0.5 + om.tco*0.3 + (r()-0.5)*4), 22, 58)),
    processing: quarterLabels.map(() => clamp(Math.round(14 + (r()-0.5)*3), 8, 22)),
    intake: quarterLabels.map(() => clamp(Math.round(17 + (r()-0.5)*2), 12, 24)),
  };
  costTrend.netTCO = costTrend.repair.map((v,i) => v + costTrend.processing[i] + costTrend.intake[i] + Math.round(40 + rm.tco*0.5 + (r()-0.5)*6));

  // ── VENDOR DATA ──
  const vendorBase = [
    { name: 'CellTech Solutions', cost: 28, turn: 2.1, dispute: 1.2, gradeVar: 0.8, devices: 124500, score: 94 },
    { name: 'DevicePro Services', cost: 33, turn: 2.6, dispute: 2.1, gradeVar: 1.0, devices: 112300, score: 88 },
    { name: 'MobileCare Inc.', cost: 36, turn: 3.0, dispute: 3.4, gradeVar: 1.3, devices: 105100, score: 81 },
    { name: 'RenewTek Partners', cost: 41, turn: 3.8, dispute: 4.7, gradeVar: 1.6, devices: 98200, score: 72 },
    { name: 'Apex Device Lab', cost: 44, turn: 4.2, dispute: 5.2, gradeVar: 1.9, devices: 87600, score: 65 },
    { name: 'QuickFix Depot', cost: 54, turn: 5.1, dispute: 8.3, gradeVar: 2.9, devices: 67800, score: 48 },
  ];
  const vendors = vendorBase.map(v => ({
    ...v,
    cost: clamp(Math.round(v.cost + tm.tco*0.2 + rm.tco*0.3 + (r()-0.5)*4), 18, 72),
    turn: clamp(+(v.turn + tm.tco*0.02 + rm.tco*0.05 + (r()-0.5)*0.4).toFixed(1), 1.2, 7.8),
    dispute: clamp(+(v.dispute + tm.risk*0.1 + rm.risk*0.2 + (r()-0.5)*0.8).toFixed(1), 0.3, 12.4),
    gradeVar: clamp(+(v.gradeVar + (r()-0.5)*0.4).toFixed(1), 0.3, 4.2),
    devices: Math.round(v.devices * rm.deviceMult * om.deviceMult * (0.85 + r()*0.3)),
    score: clamp(Math.round(v.score + tm.recovery*0.5 + rm.recovery*0.3 - rm.risk*0.4 + (r()-0.5)*4), 20, 99),
  }));
  vendors.sort((a,b) => b.score - a.score);

  const vendorRadar = vendors.slice(0,3).map(v => ({
    name: v.name,
    data: [
      clamp(Math.round(100 - v.cost*1.2 + (r()-0.5)*6), 20, 99),
      clamp(Math.round(100 - v.turn*12 + (r()-0.5)*6), 20, 99),
      clamp(Math.round(100 - v.dispute*8 + (r()-0.5)*6), 20, 99),
      clamp(Math.round(100 - v.gradeVar*18 + (r()-0.5)*6), 20, 99),
      clamp(Math.round(v.devices / 1200 + (r()-0.5)*10), 30, 99),
    ],
  }));

  const vendorDisputeTrend = vendors.slice(0,3).map(v => ({
    name: v.name,
    data: monthLabels.map((_,i) => clamp(+(v.dispute + (r()-0.5)*1.2 + Math.sin(i*0.6)*0.4).toFixed(1), 0.2, 14)),
  }));

  const avgTurnAround = +(vendors.reduce((s,v) => s + v.turn, 0) / vendors.length).toFixed(1);
  const disputeCostAnnual = clamp(+(1.1 * rm.deviceMult * om.deviceMult + tm.risk*0.05 + (r()-0.5)*0.3).toFixed(1), 0.1, 4.2);
  const avgGradeVar = +(vendors.reduce((s,v) => s + v.gradeVar, 0) / vendors.length).toFixed(1);

  // ── BATCH RISK DATA ──
  const riskOffset = tm.risk + rm.risk + om.risk;
  const flaggedBatches = clamp(Math.round(14 + riskOffset*0.8 + (r()-0.5)*4), 2, 32);
  const atRiskDevices = clamp(Math.round(23847 * (1 + riskOffset*0.04) * rm.deviceMult * om.deviceMult + (r()-0.5)*3000), 800, 68000);
  const projExposure = clamp(+(3.6 * (1 + riskOffset*0.05) * rm.deviceMult * om.deviceMult + (r()-0.5)*0.5).toFixed(1), 0.2, 12.8);
  const avgFlaggedFailRate = clamp(+(18.7 + riskOffset*0.6 + (r()-0.5)*3).toFixed(1), 8, 34);

  const heatmapModels = (oem === 'all') ? ['iPhone 15 Pro','Galaxy S24 Ultra','Galaxy S24+','Pixel 8 Pro','iPhone 14','Moto G Power'] :
    models.slice(0, Math.min(6, models.length));
  const heatmapQuarters = ['Q1 \'25','Q2 \'25','Q3 \'25','Q4 \'25','Q1 \'24','Q2 \'24'];
  const heatmapData = heatmapModels.map(m => {
    return heatmapQuarters.map(() => {
      const base = 3.5 + riskOffset*0.3;
      let val = clamp(+(base + (r()-0.3)*8).toFixed(1), 1.8, 24);
      // Samsung/Moto models get higher spikes
      if ((m.includes('Galaxy') || m.includes('Moto')) && r() > 0.5) val = clamp(+(val * (1.3 + r()*0.5)).toFixed(1), 1.8, 24);
      return val;
    });
  });

  const batchDistNormal = [42,128,86,34,18,8,4,0,0].map(v => clamp(Math.round(v * rm.deviceMult * om.deviceMult + (r()-0.5)*8), 0, 200));
  const batchDistFlagged = [0,0,0,2,3,2,3,2,2].map(v => clamp(Math.round(v + riskOffset*0.15 + (r()-0.5)*1.2), 0, 12));

  const anomalyWeeks = Array.from({length: 24}, (_, i) => 'W' + (i + 1));
  const anomalyBaseline = 4.2 + riskOffset*0.1;
  const anomalyThreshold = 8.0 + riskOffset*0.15;
  const anomalyActual = anomalyWeeks.map((_,i) => {
    const spike1 = (i >= 7 && i <= 11) ? (3 + riskOffset*0.3) * Math.sin((i-7)*0.7) : 0;
    const spike2 = (i >= 18 && i <= 22) ? (4 + riskOffset*0.4) * Math.sin((i-18)*0.6) : 0;
    return clamp(+(anomalyBaseline + spike1 + spike2 + (r()-0.5)*1.5).toFixed(1), 2, 22);
  });

  const failures = ['Display flex cable','Battery degradation','Charging port','Proximity sensor','Motherboard','Speaker module','Camera lens','Touch IC'];
  const statuses = ['Critical','Watch','Monitor'];
  const batchTableRows = [];
  for (let i = 0; i < Math.min(flaggedBatches, 8); i++) {
    const sku = models[i % models.length] + (r() > 0.5 ? ' 256GB' : ' 128GB');
    const failRate = clamp(+(avgFlaggedFailRate - i*1.8 + (r()-0.5)*3).toFixed(1), 5.2, 28);
    const units = Math.round(2000 + r()*5000);
    const exposure = Math.round(units * failRate * 0.9);
    batchTableRows.push({
      id: 'BT-' + String.fromCharCode(65 + Math.floor(r()*6)) + Math.floor(r()*9) + '-' + String(Math.round(r()*9000)).padStart(4,'0'),
      sku, date: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][Math.floor(r()*12)] + ' 2025',
      units, failRate, failure: failures[Math.floor(r()*failures.length)],
      exposure: exposure >= 1000 ? '$' + (exposure/1000).toFixed(0) + 'K' : '$' + exposure,
      status: failRate > 12 ? statuses[0] : failRate > 7 ? statuses[1] : statuses[2],
    });
  }

  return {
    totalDevices, avgRecovery, revenueUplift, sellWindow, bestChannel, channelPremium,
    modelRecoverySorted, recoveryTimeline, channelData, depreciation, monthLabels,
    avgTCO, repairRatio, costSavings, highestCostModel, modelCostData, waterfallBase, costTrend, quarterLabels,
    vendors, vendorRadar, vendorDisputeTrend, avgTurnAround, disputeCostAnnual, avgGradeVar,
    flaggedBatches, atRiskDevices, projExposure, avgFlaggedFailRate,
    heatmapModels, heatmapQuarters, heatmapData,
    batchDistNormal, batchDistFlagged, anomalyWeeks, anomalyBaseline, anomalyThreshold, anomalyActual,
    batchTableRows,
    filterLabel: `${tm.label} · ${rm.label} · ${om.label}`,
  };
}

// ══════════════════════════════════════════════════════════
// CHART.JS DEFAULTS & HELPERS
// ══════════════════════════════════════════════════════════

Chart.defaults.color = '#94a3b8';
Chart.defaults.borderColor = 'rgba(51,65,85,0.5)';
Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";

const A = (hex, a) => {
  const rv = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return `rgba(${rv},${g},${b},${a})`;
};

const gridCol = 'rgba(51,65,85,0.3)';
const gridColFaint = 'rgba(51,65,85,0.15)';
const legendOpts = { position: 'top', labels: { boxWidth: 12, padding: 16 }};

// Chart instance registry
const charts = {};
function destroyChart(id) { if (charts[id]) { charts[id].destroy(); delete charts[id]; } }

function makeKPI(label, value, valueClass, delta, deltaClass) {
  return `<div class="kpi-card"><div class="kpi-label">${label}</div>` +
    `<div class="kpi-value" style="color:var(--${valueClass})">${value}</div>` +
    `<div class="kpi-delta" style="color:var(--${deltaClass})">${delta}</div></div>`;
}

function badgeFor(val, thresholds) {
  if (val >= thresholds[0]) return 'green';
  if (val >= thresholds[1]) return 'amber';
  return 'red';
}

function marginBadge(m) {
  const cls = m >= 18 ? 'green' : m >= 10 ? 'amber' : 'red';
  return `<span class="badge ${cls}">+${m}%</span>`;
}

function heatClass(v) {
  if (v < 5) return 'low';
  if (v < 8) return 'med';
  if (v < 15) return 'high';
  return 'crit';
}

function vendorColor(score) {
  if (score >= 80) return 'var(--green)';
  if (score >= 65) return 'var(--amber)';
  return 'var(--red)';
}

function fmt(n) { return n.toLocaleString(); }

// ══════════════════════════════════════════════════════════
// RENDER DASHBOARD
// ══════════════════════════════════════════════════════════

function renderDashboard() {
  const tp = document.getElementById('filterTimePeriod').value;
  const rg = document.getElementById('filterRegion').value;
  const oem = document.getElementById('filterOem').value;
  const d = generateData(tp, rg, oem);

  // Device count
  document.getElementById('deviceCount').innerHTML =
    `<span class="filter-active-indicator"></span>Total Devices in View: <strong style="color: var(--text-primary);">${fmt(d.totalDevices)}</strong>`;

  // ── TAB 1: RESIDUAL VALUE ──
  const deltaRecovery = d.avgRecovery > 68 ? `▲ ${(d.avgRecovery - 65.2).toFixed(1)}% vs prior year` : `▼ ${(65.2 - d.avgRecovery).toFixed(1)}% vs prior year`;
  document.getElementById('kpi-residual').innerHTML =
    makeKPI('Avg. Recovery Rate', d.avgRecovery+'%', 'green', deltaRecovery, d.avgRecovery > 66 ? 'green' : 'red') +
    makeKPI('Revenue Uplift Opportunity', '$'+d.revenueUplift+'M', 'accent-light', 'Estimated from timing optimization', 'text-muted') +
    makeKPI('Optimal Sell Window', d.sellWindow, 'purple', 'Post-intake processing sweet spot', 'text-muted') +
    makeKPI('Best-Performing Channel', d.bestChannel, 'green', `▲ ${d.channelPremium}% premium vs auction`, 'green');

  // Recovery by model
  destroyChart('recovery-model');
  const colors = d.modelRecoverySorted.map(m => m.val >= 70 ? A('#22c55e',0.7) : m.val >= 60 ? A('#3b82f6',0.7) : m.val >= 50 ? A('#f59e0b',0.6) : A('#ef4444',0.5));
  charts['recovery-model'] = new Chart(document.getElementById('chart-recovery-model'), {
    type: 'bar',
    data: { labels: d.modelRecoverySorted.map(m=>m.model), datasets: [{ label:'Recovery Rate %', data: d.modelRecoverySorted.map(m=>m.val), backgroundColor: colors, borderRadius: 6, borderSkipped: false }] },
    options: { indexAxis:'y', responsive:true, plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.raw+'% recovery rate'}}}, scales:{x:{max:100,grid:{color:gridCol}},y:{grid:{display:false}}} }
  });

  // Recovery timeline
  destroyChart('recovery-time');
  charts['recovery-time'] = new Chart(document.getElementById('chart-recovery-time'), {
    type: 'line',
    data: { labels: d.monthLabels, datasets: [{ label:'Recovery Rate', data: d.recoveryTimeline, borderColor:'#3b82f6', backgroundColor:A('#3b82f6',0.1), fill:true, tension:0.4, pointRadius:4, pointHoverRadius:7, pointBackgroundColor:'#3b82f6' }] },
    options: { responsive:true, plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.raw+'%'}}}, scales:{y:{min:Math.min(...d.recoveryTimeline)-4,max:Math.max(...d.recoveryTimeline)+4,grid:{color:gridCol}},x:{grid:{color:gridColFaint}}} }
  });

  // Channel performance
  destroyChart('channel');
  charts['channel'] = new Chart(document.getElementById('chart-channel'), {
    type: 'bar',
    data: { labels:['Grade A','Grade B','Grade C','Grade D'], datasets:[
      {label:'Direct B2B',data:d.channelData.b2b,backgroundColor:A('#22c55e',0.8),borderRadius:4},
      {label:'Wholesale',data:d.channelData.wholesale,backgroundColor:A('#3b82f6',0.8),borderRadius:4},
      {label:'Auction',data:d.channelData.auction,backgroundColor:A('#f59e0b',0.7),borderRadius:4},
      {label:'Recycle',data:d.channelData.recycle,backgroundColor:A('#64748b',0.5),borderRadius:4},
    ]},
    options: { responsive:true, plugins:{legend:legendOpts,tooltip:{callbacks:{label:c=>c.dataset.label+': '+c.raw+'%'}}}, scales:{y:{max:100,grid:{color:gridCol}},x:{grid:{display:false}}} }
  });

  // Depreciation
  destroyChart('depreciation');
  const weekLabels = ['Week 0','Week 1','Week 2','Week 3','Week 4','Week 6','Week 8','Week 12'];
  charts['depreciation'] = new Chart(document.getElementById('chart-depreciation'), {
    type: 'line',
    data: { labels: weekLabels, datasets: [
      {label:'Grade A',data:d.depreciation.A,borderColor:'#22c55e',backgroundColor:'transparent',tension:0.3,pointRadius:3},
      {label:'Grade B',data:d.depreciation.B,borderColor:'#3b82f6',backgroundColor:'transparent',tension:0.3,pointRadius:3},
      {label:'Grade C',data:d.depreciation.C,borderColor:'#f59e0b',backgroundColor:'transparent',tension:0.3,pointRadius:3},
      {label:'Grade D',data:d.depreciation.D,borderColor:'#ef4444',backgroundColor:'transparent',tension:0.3,pointRadius:3},
    ]},
    options: { responsive:true, plugins:{legend:legendOpts,tooltip:{callbacks:{label:c=>c.dataset.label+': '+c.raw+'% retained'}}}, scales:{y:{min:0,max:105,title:{display:true,text:'% of Intake Value'},grid:{color:gridCol}},x:{grid:{color:gridColFaint}}} }
  });

  // ── TAB 2: LIFECYCLE COST ──
  const deltaTCO = d.avgTCO > 120 ? `▲ $${d.avgTCO - 119} vs prior year` : `▼ $${119 - d.avgTCO} vs prior year`;
  document.getElementById('kpi-lifecycle').innerHTML =
    makeKPI('Avg. TCO per Device', '$'+d.avgTCO, 'accent-light', deltaTCO, d.avgTCO > 125 ? 'red' : 'green') +
    makeKPI('Highest-Cost Model', d.highestCostModel.name, 'red', '$'+d.highestCostModel.tco+' avg. lifecycle cost', 'text-muted') +
    makeKPI('Cost Savings Potential', '$'+d.costSavings+'M', 'green', 'From model mix optimization', 'green') +
    makeKPI('Repair Cost Ratio', d.repairRatio+'%', 'amber', '% of TCO attributed to repair', 'text-muted');

  // Waterfall
  destroyChart('tco-waterfall');
  const wf = d.waterfallBase;
  const wfLabels = ['Trade-In Cost','Intake & Triage','Diagnostics','Repair','Processing','Inventory Hold','Warranty Recovery','Net TCO'];
  let runningTotal = 0;
  const wfBase = [], wfVals = [];
  const wfItems = [wf.tradeIn, wf.intake, wf.diag, wf.repair, wf.process, wf.inventory, wf.warranty, wf.total];
  wfItems.forEach((v,i) => {
    if (i === wfItems.length-1) { wfBase.push(0); wfVals.push(v); }
    else if (v < 0) { wfBase.push(runningTotal + v); wfVals.push(-v); runningTotal += v; }
    else { wfBase.push(runningTotal); wfVals.push(v); runningTotal += v; }
  });
  charts['tco-waterfall'] = new Chart(document.getElementById('chart-tco-waterfall'), {
    type:'bar', data:{ labels:wfLabels, datasets:[
      {label:'Base',data:wfBase,backgroundColor:'transparent',borderWidth:0},
      {label:'Cost / Recovery',data:wfVals,backgroundColor:wfVals.map((_,i)=>i===6?A('#22c55e',0.8):i===7?A('#3b82f6',0.9):A('#ef4444',0.15+i*0.08)),borderRadius:4},
    ]},
    options:{ responsive:true, plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>{if(c.datasetIndex===0)return'';return '$'+Math.abs(c.raw)}}}}, scales:{x:{stacked:true,grid:{display:false}},y:{stacked:true,title:{display:true,text:'Cost ($)'},grid:{color:gridCol}}} }
  });

  // TCO by model
  destroyChart('tco-model');
  charts['tco-model'] = new Chart(document.getElementById('chart-tco-model'), {
    type:'bar', data:{ labels:d.modelCostData.map(m=>m.name.length>14?m.name.slice(0,14)+'…':m.name), datasets:[
      {label:'Intake',data:d.modelCostData.map(m=>m.intake),backgroundColor:A('#64748b',0.6),borderRadius:2},
      {label:'Repair',data:d.modelCostData.map(m=>m.repair),backgroundColor:A('#ef4444',0.6),borderRadius:2},
      {label:'Processing',data:d.modelCostData.map(m=>m.processing),backgroundColor:A('#f59e0b',0.6),borderRadius:2},
    ]},
    options:{ responsive:true, plugins:{legend:legendOpts,tooltip:{mode:'index'}}, scales:{x:{stacked:true,grid:{display:false}},y:{stacked:true,title:{display:true,text:'Cost ($)'},grid:{color:gridCol}}} }
  });

  // Cost trend
  destroyChart('cost-trend');
  charts['cost-trend'] = new Chart(document.getElementById('chart-cost-trend'), {
    type:'line', data:{ labels:d.quarterLabels, datasets:[
      {label:'Repair',data:d.costTrend.repair,borderColor:'#ef4444',tension:0.3,pointRadius:4},
      {label:'Processing',data:d.costTrend.processing,borderColor:'#f59e0b',tension:0.3,pointRadius:4},
      {label:'Intake',data:d.costTrend.intake,borderColor:'#64748b',tension:0.3,pointRadius:4},
      {label:'Net TCO',data:d.costTrend.netTCO,borderColor:'#3b82f6',borderWidth:3,tension:0.3,pointRadius:5,borderDash:[5,5]},
    ]},
    options:{ responsive:true, plugins:{legend:legendOpts}, scales:{y:{title:{display:true,text:'Cost ($)'},grid:{color:gridCol}},x:{grid:{color:gridColFaint}}} }
  });

  // Lifecycle table
  document.getElementById('lifecycle-table-container').innerHTML = `<table class="data-table"><thead><tr>
    <th>Model</th><th>Intake Cost</th><th>Repair Cost</th><th>Processing</th><th>Warranty Recovery</th><th>Net TCO</th><th>Margin</th></tr></thead><tbody>` +
    d.modelCostData.map(m => `<tr><td>${m.name}</td><td>$${m.intake}</td><td>$${m.repair}</td><td>$${m.processing}</td>` +
      `<td>−$${Math.abs(m.warranty)}</td><td style="font-weight:700;">$${m.tco}</td><td>${marginBadge(m.margin)}</td></tr>`).join('') +
    `</tbody></table>`;

  // ── TAB 3: VENDOR ──
  document.getElementById('kpi-vendor').innerHTML =
    makeKPI('Top-Rated Vendor', d.vendors[0].name, 'green', 'Score: '+d.vendors[0].score+'/100', 'green') +
    makeKPI('Avg. Turnaround Time', d.avgTurnAround+' days', 'accent-light', d.avgTurnAround < 3.5 ? '▼ Improving vs prior year' : '▲ Slower vs prior year', d.avgTurnAround < 3.5 ? 'green' : 'red') +
    makeKPI('Dispute Cost (Annual)', '$'+d.disputeCostAnnual+'M', 'red', d.disputeCostAnnual > 1 ? '▲ Above target' : '▼ Under target', d.disputeCostAnnual > 1 ? 'red' : 'green') +
    makeKPI('Grading Variance', '±'+d.avgGradeVar+' pts', 'amber', 'Across all facilities', 'text-muted');

  // Vendor cards (top 3)
  const top3 = d.vendors.slice(0,3);
  document.getElementById('vendor-cards-container').innerHTML = `<div class="vendor-cards">` +
    top3.map(v => {
      const color = vendorColor(v.score);
      const scoreBadge = v.score >= 80 ? 'green' : v.score >= 60 ? 'amber' : 'red';
      return `<div class="vendor-card" style="border-left: 3px solid ${color};">
        <div class="vendor-name">${v.name}</div>
        <div class="vendor-stat"><span class="vendor-stat-label">Cost per Repair</span><span class="vendor-stat-value" style="color:${color}">$${v.cost}</span></div>
        <div class="vendor-stat"><span class="vendor-stat-label">Turnaround</span><span class="vendor-stat-value">${v.turn} days</span></div>
        <div class="vendor-stat"><span class="vendor-stat-label">Dispute Rate</span><span class="vendor-stat-value" style="color:${color}">${v.dispute}%</span></div>
        <div class="vendor-stat"><span class="vendor-stat-label">Grading Variance</span><span class="vendor-stat-value">±${v.gradeVar} pts</span></div>
        <div class="vendor-stat"><span class="vendor-stat-label">Devices Processed</span><span class="vendor-stat-value">${fmt(v.devices)}</span></div>
        <div class="vendor-stat"><span class="vendor-stat-label">Overall Score</span><span class="vendor-stat-value"><span class="badge ${scoreBadge}">${v.score} / 100</span></span></div>
      </div>`;
    }).join('') + `</div>`;

  // Vendor radar
  destroyChart('vendor-radar');
  const radarColors = ['#22c55e','#f59e0b','#ef4444'];
  charts['vendor-radar'] = new Chart(document.getElementById('chart-vendor-radar'), {
    type:'radar', data:{ labels:['Cost Efficiency','Speed','Quality (Low Disputes)','Grading Accuracy','Volume Capacity'],
      datasets: d.vendorRadar.map((v,i) => ({label:v.name,data:v.data,borderColor:radarColors[i],backgroundColor:A(radarColors[i],0.12),pointBackgroundColor:radarColors[i]})) },
    options:{ responsive:true, plugins:{legend:legendOpts}, scales:{r:{min:0,max:100,ticks:{stepSize:25,color:'#64748b',backdropColor:'transparent'},grid:{color:'rgba(51,65,85,0.4)'},angleLines:{color:'rgba(51,65,85,0.4)'},pointLabels:{color:'#94a3b8',font:{size:11}}}} }
  });

  // Vendor dispute trend
  destroyChart('vendor-dispute');
  charts['vendor-dispute'] = new Chart(document.getElementById('chart-vendor-dispute'), {
    type:'line', data:{ labels:d.monthLabels,
      datasets: d.vendorDisputeTrend.map((v,i) => ({label:v.name,data:v.data,borderColor:radarColors[i],tension:0.3,pointRadius:3})) },
    options:{ responsive:true, plugins:{legend:legendOpts,tooltip:{callbacks:{label:c=>c.dataset.label+': '+c.raw+'%'}}}, scales:{y:{title:{display:true,text:'Dispute Rate %'},grid:{color:gridCol}},x:{grid:{color:gridColFaint}}} }
  });

  // Vendor table
  document.getElementById('vendor-table-container').innerHTML = `<table class="data-table"><thead><tr>
    <th>Rank</th><th>Vendor</th><th>Cost/Repair</th><th>Turnaround</th><th>Dispute Rate</th><th>Grade Var.</th><th>Devices</th><th>Score</th></tr></thead><tbody>` +
    d.vendors.map((v,i) => {
      const badge = v.score >= 80 ? 'green' : v.score >= 60 ? 'amber' : 'red';
      return `<tr><td>${i+1}</td><td>${v.name}</td><td>$${v.cost}</td><td>${v.turn}d</td><td>${v.dispute}%</td><td>±${v.gradeVar}</td><td>${fmt(v.devices)}</td><td><span class="badge ${badge}">${v.score}</span></td></tr>`;
    }).join('') + `</tbody></table>`;

  // ── TAB 4: BATCH RISK ──
  const flagDelta = d.flaggedBatches > 12 ? `▲ ${d.flaggedBatches - 10} vs prior quarter` : `▼ ${10 - d.flaggedBatches} vs prior quarter`;
  document.getElementById('kpi-batch').innerHTML =
    makeKPI('Flagged Batches', d.flaggedBatches, 'red', flagDelta, d.flaggedBatches > 12 ? 'red' : 'green') +
    makeKPI('At-Risk Devices', fmt(d.atRiskDevices), 'amber', (d.atRiskDevices / d.totalDevices * 100).toFixed(1) + '% of total inventory', 'text-muted') +
    makeKPI('Projected Exposure', '$'+d.projExposure+'M', 'red', 'Potential loss from flagged cohorts', 'text-muted') +
    makeKPI('Avg. Failure Rate (Flagged)', d.avgFlaggedFailRate+'%', 'red', 'vs 4.2% baseline', 'text-muted');

  // Heatmap
  let heatHtml = `<div class="heatmap-grid" style="grid-template-columns: 120px repeat(${d.heatmapQuarters.length}, 1fr);">`;
  heatHtml += `<div class="heatmap-header"></div>`;
  d.heatmapQuarters.forEach(q => { heatHtml += `<div class="heatmap-header">${q}</div>`; });
  d.heatmapModels.forEach((model, mi) => {
    heatHtml += `<div class="heatmap-row-label">${model}</div>`;
    d.heatmapData[mi].forEach(val => {
      heatHtml += `<div class="heatmap-cell ${heatClass(val)}" title="${val}% failure rate">${val}%</div>`;
    });
  });
  heatHtml += `</div>`;
  document.getElementById('heatmap-container').innerHTML = heatHtml;

  // Batch dist
  destroyChart('batch-dist');
  charts['batch-dist'] = new Chart(document.getElementById('chart-batch-dist'), {
    type:'bar', data:{ labels:['0-2%','2-4%','4-6%','6-8%','8-10%','10-12%','12-15%','15-20%','20%+'],
      datasets:[
        {label:'Normal Batches',data:d.batchDistNormal,backgroundColor:A('#3b82f6',0.6),borderRadius:4},
        {label:'Flagged Batches',data:d.batchDistFlagged,backgroundColor:A('#ef4444',0.8),borderRadius:4},
      ]},
    options:{ responsive:true, plugins:{legend:legendOpts}, scales:{x:{stacked:true,title:{display:true,text:'Failure Rate Range'},grid:{display:false}},y:{stacked:true,title:{display:true,text:'Number of Batches'},grid:{color:gridCol}}} }
  });

  // Anomaly timeline
  destroyChart('batch-anomaly');
  charts['batch-anomaly'] = new Chart(document.getElementById('chart-batch-anomaly'), {
    type:'line', data:{ labels:d.anomalyWeeks, datasets:[
      {label:'Return Rate',data:d.anomalyActual,borderColor:'#ef4444',backgroundColor:A('#ef4444',0.1),fill:true,tension:0.3,
        pointRadius: d.anomalyActual.map(v => v > d.anomalyThreshold ? 6 : 3),
        pointBackgroundColor: d.anomalyActual.map(v => v > d.anomalyThreshold ? '#ef4444' : A('#ef4444',0.5))},
      {label:'Threshold ('+d.anomalyThreshold.toFixed(1)+'%)',data:d.anomalyWeeks.map(()=>d.anomalyThreshold),borderColor:A('#f59e0b',0.6),borderDash:[6,4],pointRadius:0,fill:false},
      {label:'Baseline ('+d.anomalyBaseline.toFixed(1)+'%)',data:d.anomalyWeeks.map(()=>d.anomalyBaseline),borderColor:A('#64748b',0.4),borderDash:[3,3],pointRadius:0,fill:false},
    ]},
    options:{ responsive:true, plugins:{legend:legendOpts,tooltip:{callbacks:{label:c=>c.dataset.label+': '+c.raw+'%'}}}, scales:{y:{title:{display:true,text:'Return Rate %'},grid:{color:gridCol}},x:{grid:{color:gridColFaint}}} }
  });

  // Batch table
  document.getElementById('batch-table-container').innerHTML = `<table class="data-table"><thead><tr>
    <th>Batch ID</th><th>SKU</th><th>Mfg. Date</th><th>Units</th><th>Failure Rate</th><th>Primary Failure</th><th>Est. Exposure</th><th>Status</th></tr></thead><tbody>` +
    d.batchTableRows.map(b => {
      const statusBadge = b.status === 'Critical' ? 'red' : b.status === 'Watch' ? 'amber' : 'blue';
      const failColor = b.failRate > 12 ? 'var(--red)' : 'var(--amber)';
      return `<tr><td>${b.id}</td><td>${b.sku}</td><td>${b.date}</td><td>${fmt(b.units)}</td>` +
        `<td style="color:${failColor};font-weight:700;">${b.failRate}%</td><td>${b.failure}</td><td>${b.exposure}</td>` +
        `<td><span class="badge ${statusBadge}">${b.status}</span></td></tr>`;
    }).join('') + `</tbody></table>`;
}

// ══════════════════════════════════════════════════════════
// TAB SWITCHING
// ══════════════════════════════════════════════════════════

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// ══════════════════════════════════════════════════════════
// FILTER EVENT LISTENERS — full re-render on change
// ══════════════════════════════════════════════════════════

document.querySelectorAll('.filter-select').forEach(sel => {
  sel.addEventListener('change', () => {
    const main = document.getElementById('mainContent');
    main.style.opacity = '0.4';
    setTimeout(() => {
      renderDashboard();
      main.style.opacity = '1';
    }, 200);
  });
});

// Initial render
renderDashboard();
</script>
</body>
</html>
